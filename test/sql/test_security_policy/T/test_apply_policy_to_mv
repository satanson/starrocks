-- name: test_apply_policy_to_mv
create database test_apply_policy_to_mv;
use test_apply_policy_to_mv;
create masking policy mp as (v1 bigint) returns bigint -> v1 + 1;
create row access policy rp as (v1 bigint) returns boolean -> true;

CREATE TABLE `t0` (
  `v1` bigint(20) NULL COMMENT "",
  `v2` bigint(20) NULL COMMENT "",
  `v3` bigint(20) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`v1`, `v2`, `v3`)
DISTRIBUTED BY RANDOM
PROPERTIES (
"replication_num" = "1",
"in_memory" = "false",
"enable_persistent_index" = "false",
"replicated_storage" = "true",
"compression" = "LZ4"
);

create materialized view mv distributed by hash(v1) buckets 10 REFRESH ASYNC as select * from t0;

alter materialized view mv modify column v1 set masking policy mp;
select * from sys.policy_references where POLICY_DATABASE="test_apply_policy_to_mv";
alter materialized view mv modify column v1 unset masking policy;
select * from sys.policy_references where POLICY_DATABASE="test_apply_policy_to_mv";

alter materialized view mv add row access policy rp on (v1);
select * from sys.policy_references where POLICY_DATABASE="test_apply_policy_to_mv";
alter materialized view mv drop row access policy rp;
select * from sys.policy_references where POLICY_DATABASE="test_apply_policy_to_mv";

alter table t0 modify column v1 set masking policy mp;
alter table t0 add row access policy rp on (v1);

CREATE TABLE `test_policy` (
  `v1` bigint(20) NULL WITH MASKING POLICY mp COMMENT "",
  `v2` bigint(20) NULL COMMENT "",
  `v3` bigint(20) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`v1`, `v2`, `v3`)
DISTRIBUTED BY RANDOM
PROPERTIES (
"replication_num" = "1",
"in_memory" = "false",
"enable_persistent_index" = "false",
"replicated_storage" = "true",
"compression" = "LZ4"
);
create materialized view mv2 distributed by hash(v1) buckets 10 REFRESH ASYNC as select * from test_policy;