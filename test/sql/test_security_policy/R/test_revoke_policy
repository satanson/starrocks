-- name: test_revoke_policy
create database test_revoke_policy;
-- result:
-- !result
use test_revoke_policy;
-- result:
-- !result
create masking policy mp1 as (v1 bigint) returns bigint -> v1 + 1;
-- result:
-- !result
create masking policy mp2 as (v1 bigint) returns bigint -> v1 + 2;
-- result:
-- !result
create masking policy mp3 as (v1 bigint) returns bigint -> v1 + 3;
-- result:
-- !result
create row access policy rp1 as (v1 bigint) returns boolean -> true;
-- result:
-- !result
create row access policy rp2 as (v1 bigint) returns boolean -> true;
-- result:
-- !result
create row access policy rp3 as (v1 bigint) returns boolean -> true;
-- result:
-- !result
CREATE TABLE `t0` (
  `v1` bigint(20) NULL COMMENT "",
  `v2` bigint(20) NULL COMMENT "",
  `v3` bigint(20) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`v1`, `v2`, `v3`)
DISTRIBUTED BY RANDOM
PROPERTIES (
"replication_num" = "1",
"in_memory" = "false",
"enable_persistent_index" = "false",
"replicated_storage" = "true",
"compression" = "LZ4"
);
-- result:
-- !result
alter table t0 modify column v1 set masking policy mp1;
-- result:
-- !result
select * from sys.policy_references where POLICY_DATABASE="test_revoke_policy";
-- result:
test_revoke_policy	mp1	Column Masking	default_catalog	test_revoke_policy	t0	v1
-- !result
alter table t0 modify column v1 set masking policy mp1;
-- result:
E: (1064, 'Unexpected exception: Getting analyzing error. Detail message: A masking policy already exists in the current column[v1], and only supports applying a masking policy to a specific column.')
-- !result
alter table t0 add row access policy rp1 on(v1);
-- result:
-- !result
select * from sys.policy_references where POLICY_DATABASE="test_revoke_policy";
-- result:
test_revoke_policy	mp1	Column Masking	default_catalog	test_revoke_policy	t0	v1
test_revoke_policy	rp1	Row Access	default_catalog	test_revoke_policy	t0	None
-- !result
alter table t0 add row access policy rp1 on(v1);
-- result:
E: (1064, 'Unexpected exception: Getting analyzing error. Detail message: The same Policy has already been applied to this table.')
-- !result
alter table t0 add row access policy rp2 on(v1);
-- result:
-- !result
select * from sys.policy_references where POLICY_DATABASE="test_revoke_policy";
-- result:
test_revoke_policy	mp1	Column Masking	default_catalog	test_revoke_policy	t0	v1
test_revoke_policy	rp1	Row Access	default_catalog	test_revoke_policy	t0	None
test_revoke_policy	rp2	Row Access	default_catalog	test_revoke_policy	t0	None
-- !result
alter table t0 add row access policy rp3 on(v1);
-- result:
-- !result
select * from sys.policy_references where POLICY_DATABASE="test_revoke_policy";
-- result:
test_revoke_policy	mp1	Column Masking	default_catalog	test_revoke_policy	t0	v1
test_revoke_policy	rp1	Row Access	default_catalog	test_revoke_policy	t0	None
test_revoke_policy	rp2	Row Access	default_catalog	test_revoke_policy	t0	None
test_revoke_policy	rp3	Row Access	default_catalog	test_revoke_policy	t0	None
-- !result
alter table t0 drop all row access policies;
-- result:
-- !result
select * from sys.policy_references where POLICY_DATABASE="test_revoke_policy";
-- result:
test_revoke_policy	mp1	Column Masking	default_catalog	test_revoke_policy	t0	v1
-- !result
alter table t0 drop all row access policies;
-- result:
-- !result
alter table t0 modify column v1 unset masking policy;
-- result:
-- !result
alter table t0 modify column v1 unset masking policy;
-- result:
-- !result
select * from sys.policy_references where POLICY_DATABASE="test_revoke_policy";
-- result:
-- !result